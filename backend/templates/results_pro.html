<!DOCTYPE html>
<html>
<head>
    <title>Pro Results - AI Log Forensics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI';background:#0a192f;color:#fff;padding:40px}.container{max-width:1400px;margin:0 auto}.back{position:fixed;top:20px;left:20px;color:#64ffda;font-size:1.5em;text-decoration:none}h1{color:#64ffda;margin-bottom:30px;text-align:center}.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:40px 0}.stat{background:rgba(10,25,47,0.9);border:2px solid #64ffda;border-radius:15px;padding:25px;text-align:center}.stat-num{font-size:2.5em;font-weight:bold}.stat-num.red{color:#ff4757}.stat-num.cyan{color:#00d4ff}.stat-num.green{color:#64ffda}.stat-label{color:#8892b0;margin-top:5px}.section{margin:40px 0;padding:30px;background:rgba(10,25,47,0.7);border-radius:20px;border:1px solid #1a1a2e}.section h2{color:#64ffda;margin-bottom:20px}.table-container{overflow:auto}.table{width:100%;background:rgba(10,25,47,0.9);border-radius:15px;overflow:hidden}.th{background:#ff4757;padding:15px;color:#fff;text-align:left}.td{padding:12px 15px;border-bottom:1px solid #1a1a2e}.tr.high{background:rgba(255,71,87,0.2)}#timeline-chart,#heatmap-chart{height:400px;margin:20px 0}.theme-toggle{position:fixed;top:20px;right:20px;background:rgba(100,255,218,0.2);border:1px solid #64ffda;border-radius:50px;padding:10px;cursor:pointer}.dark body{background:#000;color:#fff}.actions{text-align:center;margin:40px 0}.btn{display:inline-block;padding:15px 30px;background:linear-gradient(45deg,#64ffda,#00d4ff);color:#0a192f;border:none;border-radius:30px;font-weight:bold;cursor:pointer;text-decoration:none;margin:5px;font-size:1.1em}.btn-red{background:linear-gradient(45deg,#ff4757,#ff6b7a);color:#fff}.live-logs{background:#1a1a2e;padding:20px;border-radius:15px;height:200px;overflow:auto;border:1px solid #64ffda}.empty{text-align:center;padding:80px;color:#8892b0}</style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">üåô</div>
    <a href="/" class="back">‚Üê Dashboard</a>
    <div class="container">
        <h1>üöÄ Pro Analysis Dashboard</h1>
        <div id="stats-section" class="stats" style="display:none">
            <div class="stat"><div id="highrisk" class="stat-num red">0</div><div class="stat-label">HIGH-RISK</div></div>
            <div class="stat"><div id="mitrecount" class="stat-num cyan">0</div><div class="stat-label">MITRE TECH</div></div>
            <div class="stat"><div id="precision" class="stat-num green">0</div><div class="stat-label">PRECISION</div></div>
            <div class="stat"><div id="total" class="stat-num">0</div><div class="stat-label">TOTAL LOGS</div></div>
        </div>

        <div class="section">
            <h2>üìà Risk Timeline</h2>
            <canvas id="timeline-chart"></canvas>
        </div>

        <div class="section">
            <h2>üî• Top Threats</h2>
            <div class="table-container">
                <table class="table">
                    <thead><tr><th class="th">User</th><th class="th">Action</th><th class="th">Risk Score</th><th class="th">MITRE</th><th class="th">AI Explain</th></tr></thead>
                    <tbody id="threats-table"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>üå°Ô∏è MITRE Heatmap</h2>
            <canvas id="heatmap-chart"></canvas>
        </div>

        <div class="section">
            <h2>üî¥ Live Log Tail</h2>
            <div id="live-logs" class="live-logs">Connecting to live stream...</div>
            <button class="btn" onclick="startLiveLogs()">Start Live Tail</button>
        </div>

        <div class="actions">
            <a href="/reports/forensic_report.html" target="_blank" class="btn">üìÑ View Report</a>
            <a href="/download_report" class="btn btn-red">‚¨áÔ∏è Download PDF</a>
            <a href="/upload" class="btn">üîÑ New Analysis</a>
            <button class="btn" onclick="exportJSON()">üíæ Export JSON</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let timelineChart, heatmapChart, ws;
        
        async function loadData() {
            const res = await fetch('/api/results');
            const data = await res.json();
            
            if (!data.timestamp) {
                document.getElementById('stats-section').innerHTML = '<div class="empty"><h2>No Analysis</h2><p><a href="/upload" class="btn">Upload CSV First</a></p></div>';
                return;
            }
            
            // Stats
            document.getElementById('highrisk').textContent = data.highrisk;
            document.getElementById('mitrecount').textContent = data.mitrecount;
            document.getElementById('precision').textContent = data.precision + '%';
            document.getElementById('total').textContent = data.total;
            document.getElementById('stats-section').style.display = 'grid';
            
            // Threats Table
            const tbody = document.getElementById('threats-table');
            tbody.innerHTML = '';
            data.threats.forEach((t, i) => {
                const row = tbody.insertRow();
                row.className = t.risk >= 80 ? 'tr high' : '';
                row.innerHTML = `<td class="td">${t.user}</td><td class="td">${t.action}</td><td class="td"><strong>${t.risk}</strong></td><td class="td">${t.mitre}</td><td class="td">${t.explain}</td>`;
            });
            
            // Timeline Chart
            const ctx1 = document.getElementById('timeline-chart').getContext('2d');
            timelineChart = new Chart(ctx1, {
                type: 'line', data: {
                    labels: data.timeline.map(t => t.time.slice(11)),
                    datasets: [{label: 'Risk Score', data: data.timeline.map(t => t.risk), borderColor: '#ff4757', backgroundColor: 'rgba(255,71,87,0.1)', tension: 0.4}]
                },
                options: {scales: {y: {beginAtZero: true}}}
            });
            
            // Heatmap (simplified bar chart)
            const ctx2 = document.getElementById('heatmap-chart').getContext('2d');
            const heatmapData = Object.entries(data.heatmap || {}).map(([k, v]) => ({tag: k.split('|')[0], count: v}));
            heatmapChart = new Chart(ctx2, {
                type: 'bar', data: {
                    labels: heatmapData.map(d => d.tag),
                    datasets: [{label: 'Occurrences', data: heatmapData.map(d => d.count), backgroundColor: '#00d4ff'}]
                }
            });
        }
        
        function startLiveLogs() {
            ws = new WebSocket('ws://127.0.0.1:8000/ws/logs');
            ws.onmessage = (e) => {
                const log = JSON.parse(e.data);
                document.getElementById('live-logs').innerHTML += `<div>${log.log} [Risk: ${log.risk}]</div>`;
            };
        }
        function exportJSON() {
            const data = JSON.stringify(last_analysis, null, 2);  // Already declared globally
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'forensics.json'; a.click();
        }

        
        async function exportJSON() {
            const res = await fetch('/api/results');  // Fetch fresh data
            const data = await res.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `forensics_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        
        function toggleTheme() {
            document.body.classList.toggle('dark');
        }
        
        loadData();
    </script>
</body>
</html>
